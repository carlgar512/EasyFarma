import { auth } from "../../presentacion/config/firebaseConfig";
import { Usuario } from "../../negocio/modelos/Usuario";
import { db } from "../../presentacion/config/firebaseConfig";
import { UserRecord } from "firebase-admin/auth";

const USERS_COLLECTION = "users";
/**
 * Guarda un usuario en Firestore
 */
export const saveUserToFirestore = async (user: Usuario) => {
  try {
    console.log("üìÑ [DAO] Guardando en Firestore:", user.getIdUsuario());
    const userRef = db.collection(USERS_COLLECTION).doc(user.getIdUsuario());
    await userRef.set(user.toFirestoreObject());
    console.log("‚úÖ [DAO] Guardado exitoso:", user.getIdUsuario());
  } catch (error: any) {
    console.error("‚ùå [DAO] Error guardando en Firestore:", error.message);
    throw error;
  }
};

/**
 * Guarda un usuario infantil en Firestore (Firestore genera el ID autom√°ticamente)
 */
export const saveChildUserToFirestore = async (user: Usuario): Promise<string> => {
  try {
    console.log("üìÑ [DAO] Guardando usuario infantil en Firestore (ID autogenerado)");
    const userRef = await db.collection(USERS_COLLECTION).add(user.toFirestoreObject());
    console.log("‚úÖ [DAO] Usuario infantil guardado con ID:", userRef.id);
    return userRef.id;
  } catch (error: any) {
    console.error("‚ùå [DAO] Error guardando usuario infantil en Firestore:", error.message);
    throw error;
  }
};

/**
 * Busca el email de un usuario por su DNI
 */
export const getEmailByDNI = async (dni: string): Promise<string | null> => {
  const cleanDni = String(dni).trim();
  const usersRef = db.collection(USERS_COLLECTION);
  const snapshot = await usersRef.where("dni", "==", cleanDni).get();

  if (!snapshot.empty) {
    const data = snapshot.docs[0].data();
    return data.email;
  }

  return null;
};

/**
 * Busca el email de un usuario por su DNI
 */
export const getUIDByDNI = async (dni: string): Promise<string | null> => {
  const cleanDni = String(dni).trim();
  const usersRef = db.collection(USERS_COLLECTION);
  const snapshot = await usersRef.where("dni", "==", cleanDni).get();

  if (!snapshot.empty) {
    return snapshot.docs[0].id; // ‚úÖ Devuelve el ID del documento (Firestore ID)
  }

  return null;
};

/**
 * Obtiene un usuario por su UID
 */
export const getUserById = async (uid: string) => {
  try {
    const userRef = db.collection(USERS_COLLECTION).doc(uid);
    const userDoc = await userRef.get();

    if (!userDoc.exists) {
      console.log(`üîç [DAO Usuario] No se encontr√≥ usuario con ID ${uid}.`);
      return null;
    }

    console.log(`‚úÖ [DAO Usuario] Usuario con ID ${uid} encontrado.`);
    return {
      id: userDoc.id,
      ...userDoc.data(),
    };
  } catch (error: any) {
    console.error("‚ùå [DAO Usuario] Error al obtener usuario:", error.message);
    throw error;
  }
};

export const updateUserPassword = async (email: string, password: string): Promise<void> => {
  try {
    // Actualizar la contrase√±a del usuario en Firebase Authentication
    await auth.updateUser(email, {
      password: password, // Cambiar la contrase√±a
    });

    console.log(`‚úÖ Contrase√±a actualizada correctamente para el usuario con email: ${email}`);
  } catch (error: any) {
    console.error(`‚ùå Error al actualizar la contrase√±a para el usuario con email: ${email}:`, error.message);
    throw new Error(`Error al actualizar la contrase√±a para el usuario con email: ${email}`);
  }
}

export const createUserInAuth = async (email: string, password: string): Promise<UserRecord> => {
  try {
    // Crear el usuario en Firebase Authentication
    const userRecord = await auth.createUser({
      email: email,
      password: password,
    });

    console.log(`‚úÖ Usuario creado con √©xito con email: ${email}`);
    return userRecord; // Devuelve el record del usuario creado
  } catch (error: any) {
    console.error(`‚ùå Error al crear el usuario con email: ${email}`, error.message);
    throw new Error(`Error al crear el usuario con email: ${email}`);
  }
};

export const getUserByEmailFromAuth = async (email: string): Promise<UserRecord | null> => {
  try {
    // Obtiene el usuario de Firebase Authentication utilizando el correo
    const userRecord = await auth.getUserByEmail(email);

    console.log(`‚úÖ Usuario encontrado con el correo: ${email}`);
    return userRecord; // Devuelve el objeto del usuario si se encuentra
  } catch (error: any) {
    if (error.code === 'auth/user-not-found') {
      console.error(`‚ùå No se encontr√≥ un usuario con el correo: ${email}`);
    } else {
      console.error(`‚ùå Error al obtener el usuario con el correo: ${email}`, error.message);
    }
    return null; // Si el usuario no se encuentra, retorna null
  }
};

export const updateUserInFirestore = async (uid: string, userData:any) => {
  try {
    const userRef = db.collection(USERS_COLLECTION).doc(uid);
    await userRef.update(userData);
  } catch (error) {
    console.error("‚ùå [DAO User] Error al actualizar en Firestore:", error);
    throw error;
  }
};
